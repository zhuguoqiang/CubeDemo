(function(v){window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;window.addEventListener("error",function(C){if(console.log){console.log("Error:"+C.toString())}},false);var w=navigator.userAgent.toLowerCase();var x=w.match(/ipad/i)=="ipad";var j=w.match(/iphone os/i)=="iphone os";var b=w.match(/midp/i)=="midp";var A=w.match(/android/i)=="android";var q=w.match(/windows ce/i)=="windows ce";var f=w.match(/windows mobile/i)=="windows mobile";var i=document.compatMode=="CSS1Compat";var B=w.indexOf("opera")>-1;var d=w.indexOf("chrome")>-1;var g=w.indexOf("firefox")>-1;var y=!d&&!A&&(/webkit|khtml/).test(w);var u=("ActiveXObject" in window);var t=u&&!window.XMLHttpRequest;var s=u&&window.XMLHttpRequest&&!document.documentMode;var r=u&&!-[1]&&document.documentMode;var p=(navigator.appName=="Microsoft Internet Explorer")&&navigator.appVersion.match(/9./i)=="9.";var m=u&&(/10\.0/).test(w);var k=u&&w.indexOf("rv:11.0")>-1;var o=!y&&!d&&w.indexOf("gecko")>-1;var a=o&&w.indexOf("rv:1.9")>-1;var z=(w.indexOf("windows")!=-1||w.indexOf("win32")!=-1);var h=(w.indexOf("macintosh")!=-1||w.indexOf("mac os x")!=-1);var e=(w.indexOf("adobeair")!=-1);var n=(w.indexOf("linux")!=-1);var c=window.location.href.toLowerCase().indexOf("https")===0;var l=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;v.utils={isIPad:x,isIPhone:j,isAndroid:A,isPhone:(j||A),isDesktop:(!j&&!A&&!x),isWindows:z,isMac:h,isLinux:n,isChrome:d,isFirefox:g,isIE:u,isIE9:p,isIE11:k,isSafari:y,retrievalDomClass:function(E,D){var G=null;try{G=E.getAttribute("class")}catch(F){return null}if(G!=null&&G.indexOf(D)>=0){return E}var C=E.parentNode;if(C!=null&&C!==undefined){return v.utils.retrievalDomClass(C,D)}else{return null}},formatDuration:function(H){var G=H/1000;var F=parseInt(G);if(F<60){return"00:"+((F<10)?"0"+F:F)}var D=G/60;var C=parseInt(Math.floor(D));var E=parseInt(F%60);return((C<10)?"0"+C:C)+":"+((E<10)?"0"+E:E)},getUrlParams:function(){var F=[],E;var C=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var D=0;D<C.length;D++){E=C[D].split("=");F.push(E[0]);F[E[0]]=E[1]}return F},getUrlParam:function(D){var C=this.getUrlParams()[D];return(undefined===C)?null:C},getCookieVal:function(D){var C=document.cookie.indexOf(";",D);if(C==-1){C=document.cookie.length}return unescape(document.cookie.substring(D,C))},getCookie:function(F){var D=F+"=";var H=D.length;var C=document.cookie.length;var G=0;while(G<C){var E=G+H;if(document.cookie.substring(G,E)==D){return this.getCookieVal(E)}G=document.cookie.indexOf(" ",G)+1;if(G==0){break}}return null},setCookie:function(D,F,C,H,E,G){document.cookie=D+"="+escape(F)+((C)?"; expires="+C:"")+((H)?"; path="+H:"")+((E)?"; domain="+E:"")+((G)?"; secure":"")},deleteCookie:function(C,E,D){if(this.getCookie(C)){document.cookie=C+"="+((E)?"; path="+E:"")+((D)?"; domain="+D:"")+"; expires=Thu, 01-Jan-1970 00:00:01 GMT"}},getDrawPosition:function(F,E){var G=(E.touches===undefined)?this.getMousePos(E):this.getTouchPos(E);var D=this.getX(F);var C=this.getY(F);return{x:G.x-D,y:G.y-C}},getMousePos:function(D){var F=D||window.event;var G=document.documentElement.scrollLeft||document.body.scrollLeft;var E=document.documentElement.scrollTop||document.body.scrollTop;var C=F.pageX||F.clientX+G;var H=F.pageY||F.clientY+E;return{x:C,y:H}},getTouchPos:function(D){var F=D||window.event;var G=document.documentElement.scrollLeft||document.body.scrollLeft;var E=document.documentElement.scrollTop||document.body.scrollTop;var C=F.touches[0].pageX||F.clientX+G;var H=F.touches[0].pageY||F.clientY+E;return{x:C,y:H}},getX:function(E){var D=E.offsetLeft;var C=E;while((C=C.offsetParent)!=null){D+=C.offsetLeft}return D},getY:function(E){var D=E.offsetTop;var C=E;while((C=C.offsetParent)!=null){D+=C.offsetTop}return D},unselectable:function(D){D.setAttribute("unselectable","on");D.className="unselectable";D.onmousedown=function(){return false};var C=D.style;C.userSelect="none";C.webkitUserSelect="none";C.MozUserSelect="-moz-none"},verifyEmail:function(C){return(l.test(C))},isSocketSupported:function(){return(undefined!==window.WebSocket)},isSVGSupported:function(){var C="http://www.w3.org/2000/svg";return !!document.createElementNS&&!!document.createElementNS(C,"svg").createSVGRect},isDBSupported:function(){return(undefined!==window.indexedDB)},isRecorderSupported:function(){var C=window.StereoRecorder||window.MediaStreamRecorder||window.WhammyRecorder||window.GifRecorder||window.CanvasRecorder;return(undefined!==C)},isVideoSupported:function(){return !!(document.createElement("video").canPlayType)},isUserMediaSupported:function(){if(y&&null==navigator.getUserMedia){return false}var D=navigator.userAgent.indexOf("Chrome/");if(D>0){var F=navigator.userAgent.substr(D+7);var E=F.indexOf(".");if(E>0){F=F.substring(0,E);var C=parseInt(F);if(C<37){return false}}}return(undefined!==navigator.getUserMedia||undefined!==window.getUserMedia)},measureBandwidth:function(H,N,K,M){var E=H?1054738:10561396;var F=0;var I=0;var J=0;var L=0;var G=new Image();G.onload=function(){clearTimeout(L);L=0;I=Date.now();var R=(I-F)/1000;var Q=E*8;var O=(Q/R).toFixed(2);var S=(O/1024).toFixed(2);var P=(S/1024).toFixed(2);N.call(null,O,S,P)};G.onerror=function(O,P){K.call(null,O)};F=Date.now();var D="?t="+F;var C="assets/bandwidth/"+(H?"bandwidth-1m.jpg":"bandwidth-10m.jpg")+D;if(M!==undefined){C="http://"+M+"/"+C}G.src=C;L=setTimeout(function(){clearTimeout(L);L=0;K.call(null)},30000)},requestGet:function(D,F,C){var E=new XMLHttpRequest();E.onreadystatechange=function(){if(E.readyState==4){if(E.status==200){F.call(null,JSON.parse(E.responseText))}else{C.call(null,E.status)}}};E.open("GET",D);E.send(null)}}})(window);(function(e){var b,d=function(){},a=e.document,c={set:d,get:d,remove:d,clear:d,each:d,obj:d,length:0};(function(){if("localStorage" in e){try{b=e.localStorage;return}catch(p){}}var h=a.getElementsByTagName("head")[0],g=e.location.hostname||"localStorage",q=new Date(),s,l;if(!h.addBehavior){try{b=e.localStorage}catch(p){b=null}return}try{l=new ActiveXObject("htmlfile");l.open();l.write('<script>document.w=window;<\/script><iframe src="/favicon.ico"></iframe>');l.close();s=l.w.frames[0].document;h=s.createElement("head");s.appendChild(h)}catch(p){h=a.getElementsByTagName("head")[0]}try{q.setDate(q.getDate()+36500);h.addBehavior("#default#userData");h.expires=q.toUTCString();h.load(g);h.save(g)}catch(p){return}var r,t;try{r=h.XMLDocument.documentElement;t=r.attributes}catch(p){return}var m="p__hack_",j="m-_-c",k=new RegExp("^"+m),i=new RegExp(j,"g"),n=function(o){return encodeURIComponent(m+o).replace(/%/g,j)},f=function(o){return decodeURIComponent(o.replace(i,"%")).replace(k,"")};b={length:t.length,isVirtualObject:true,getItem:function(o){return(t.getNamedItem(n(o))||{nodeValue:null}).nodeValue||r.getAttribute(n(o))},setItem:function(o,u){try{r.setAttribute(n(o),u);h.save(g);this.length=t.length}catch(v){}},removeItem:function(o){try{r.removeAttribute(n(o));h.save(g);this.length=t.length}catch(u){}},clear:function(){while(t.length){this.removeItem(t[0].nodeName)}this.length=0},key:function(o){return t[o]?f(t[o].nodeName):undefined}};if(!("localStorage" in e)){e.localStorage=b}})();e.LS=!b?c:{set:function(f,g){if(this.get(f)!==undefined){this.remove(f)}b.setItem(f,g);this.length=b.length},get:function(g){var f=b.getItem(g);return f===null?undefined:f},remove:function(f){b.removeItem(f);this.length=b.length},clear:function(){b.clear();this.length=0},each:function(i){var h=this.obj(),g=i||function(){},f;for(f in h){if(g.call(this,f,this.get(f))===false){break}}},obj:function(){var h={},g=0,j,f;if(b.isVirtualObject){h=b.key(-1)}else{j=b.length;for(;g<j;g++){f=b.key(g);h[f]=this.get(f)}}return h},length:b.length};if(e.jQuery){e.jQuery.LS=e.LS}})(window);var CubeConst={ActionLogin:"login",ActionLoginAck:"login-ack",ActionLogout:"logout",ActionLogoutAck:"logout-ack",ActionQuery:"query",ActionQueryAck:"query-ack",ActionPush:"push",ActionPull:"pull",ActionPullAck:"pull-ack",ActionNotify:"notify",ActionHistory:"history",ActionHistoryAck:"history-ack",ActionInvite:"invite",ActionInviteAck:"invite-ack",ActionAnswer:"answer",ActionAnswerAck:"answer-ack",ActionCancel:"cancel",ActionCancelAck:"cancel-ack",ActionBye:"bye",ActionByeAck:"bye-ack",ActionCandidate:"candidate",ActionCandidateAck:"candidate-ack",ActionConsult:"consult",ActionConsultAck:"consult-ack",ActionConference:"conference",ActionConferenceAck:"conference-ack",ActionShare:"share",ActionShareAck:"share-ack",ActionRevoke:"revoke",ActionRevokeAck:"revoke-ack",ActionVGCmd:"vg-cmd",ActionVGCmdAck:"vg-cmd-ack",ActionCreateGroup:"create-group",ActionCreateGroupAck:"create-group-ack",ActionDeleteGroup:"delete-group",ActionDeleteGroupAck:"delete-group-ack",ActionAddMember:"add-member",ActionAddMemberAck:"add-member-ack",ActionRemoveMember:"remove-member",ActionRemoveMemberAck:"remove-member-ack",ActionQueryGroups:"query-groups",ActionQueryGroupsAck:"query-groups-ack",ActionGetGroup:"get-group",ActionGetGroupAck:"get-group-ack",Unknown:""};var CubeRegistrationState={None:"None",Progress:"Progress",Ok:"Ok",Cleared:"Cleared",Failed:"Failed"};var CubeRegistrationListener=Class({ctor:function(){},onRegistrationProgress:function(a){},onRegistrationOk:function(a){},onRegistrationCleared:function(a){},onRegistrationFailed:function(b,a){}});var CubeCallDirection={Outgoing:"outgoing",Incoming:"incoming"};var CubeCallListener=Class({ctor:function(){},onNewCall:function(c,b,a){},onInProgress:function(a){},onCallRinging:function(a){},onCallConnected:function(a){},onCallEnded:function(a){},onCallFailed:function(b,a){}});var CubeMessageErrorCode={ContentTooLong:300};var CubeMessageListener=Class({ctor:function(){},onSent:function(b,a){},onReceived:function(b,a){},onMessageFailed:function(c,b,a){}});var CubeErrorCode={BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,ProxyAuthenticationRequired:407,RequestTimeout:408,UnsupportedMediaType:415,RequestSendFailed:477,TemporarilyUnavailable:480,BusyHere:486,RequestTerminated:487,ServerInternalError:500,BusyEverywhere:600,Declined:603,ConnectionFailed:700,SignalingStartError:701,TransportError:702,ICEConnectionFailed:703,CreateSessionDescriptionFailed:705,SetSessionDescriptionFailed:706,RTCInitializeFailed:707,DuplicationException:801,WorkerStateException:802,CallTimeout:804,NetworkNotReachable:809,CameraOpenFailed:901,Unknown:0};var CubeCallErrorCode=CubeErrorCode;var CubeMediaProbe=Class({ctor:function(){},onLocalStreamReady:function(a){},onRemoteStreamReady:function(a){},onLocalVideoFPS:function(d,e,b,c,a){},onRemoteVideoFPS:function(d,e,b,c,a){},onFrameRateWarning:function(c,b,a,d){},onFrameRateRecovering:function(c,b,a,d){}});var CubeMediaController=Class({worker:null,canvas:null,timerList:[],probes:null,frameWarning:false,remoteMaxFrameRate:-1,remoteMinFrameRate:120,recorderMap:null,capturedUri:null,ctor:function(c,b){this.worker=c;if(undefined!==b){this.canvas=document.getElementById(b)}var a=this;c.videoCloseHandler=function(){Logger.d("CubeMediaController","Video closed");for(var d=0;d<a.timerList.length;++d){var f=a.timerList[d];clearInterval(f)}a.timerList.splice(0,a.timerList.length);if(c.videoEnabled){if(null!=a.probes&&a.frameWarning){for(var d=0;d<a.probes.length;++d){var e=a.probes[d];e.onFrameRateRecovering(a,0,0,a.remoteMaxFrameRate)}}}a.remoteMaxFrameRate=-1;a.remoteMinFrameRate=120;a.frameWarning=false;if(a.isLocalRecording()){a.stopLocalRecording(null)}};c.localVideoReady=function(d,e){a._localVideoReady(d,e.videoEnabled)};c.remoteVideoReady=function(d,e){d.volume=1;a._remoteVideoReady(d,e.videoEnabled)}},addMediaProbe:function(a){if(null==this.probes){this.probes=[a]}else{this.probes.push(a)}},removeMediaProbe:function(a){if(null==this.probes){return false}var b=this.probes.indexOf(a);if(b>=0){this.probes.splice(b,1);return true}return false},isVideoEnabled:function(){return this.worker.videoEnabled},getLocalVideoSize:function(){var b=this.worker.localVideo;var a=b.videoWidth;var c=b.videoHeight;return{width:a,height:c}},getRemoteVideoSize:function(){var b=this.worker.remoteVideo;var a=b.videoWidth;var c=b.videoHeight;return{width:a,height:c}},getCapturedCameraImage:function(a){if(null==this.capturedUri){return null}return this.capturedUri+a+"/cube_captured_conference_camera.png"},capture:function(e,i){var d=this.canvas;var b=parseInt(this.worker.localVideo.videoWidth);var f=parseInt(this.worker.localVideo.videoHeight);d.setAttribute("width",b);d.setAttribute("height",f);d.style.width=b+"px";d.style.height=f+"px";var a=d.getContext("2d");if(this.worker.localStream){a.drawImage(this.worker.localVideo,0,0);var g=d.toDataURL("image/png");var c=this;Ajax.newRequest("conference/capture?name="+e).method("POST").content(g).send(function(j){if(j.getStatus()==200){var h=JSON.parse(j.getData());c.capturedUri=h.uri;if(undefined!==i&&null!=i){i.call(null,h)}}})}},_autoCaptureTimer:0,_startAutoCapture:function(b,c){if(null!=this.canvas){var a=this;if(a._autoCaptureTimer>0){return true}a._autoCaptureTimer=setTimeout(function(){clearTimeout(a._autoCaptureTimer);a._autoCaptureTimer=0;a.capture(b,c);a._startAutoCapture(b,c)},8000);return true}else{return false}},_stopAutoCapture:function(){if(this._autoCaptureTimer>0){clearTimeout(this._autoCaptureTimer);this._autoCaptureTimer=0}},_localVideoReady:function(d,c){if(null!=this.probes){for(var b=0;b<this.probes.length;++b){var e=this.probes[b];e.onLocalStreamReady(this)}if(c){var a=this;this._calculateStats(d,function(f,k,j){if(!a.worker.videoEnabled){a._stopCalculate();return}for(var g=0;g<a.probes.length;++g){var h=a.probes[g];h.onLocalVideoFPS(a,f.videoWidth,f.videoHeight,k,j)}})}}},_remoteVideoReady:function(d,c){if(null!=this.probes){for(var b=0;b<this.probes.length;++b){var e=this.probes[b];e.onRemoteStreamReady(this)}if(c){var a=this;this._calculateStats(d,function(f,k,j){if(!a.worker.videoEnabled){a._stopCalculate();return}if(f.videoWidth==0||f.videoHeight==0){a._stopCalculate();return}for(var g=0;g<a.probes.length;++g){var h=a.probes[g];h.onRemoteVideoFPS(a,f.videoWidth,f.videoHeight,k,j)}if(a.remoteMaxFrameRate<k){a.remoteMaxFrameRate=k}if(a.remoteMinFrameRate>k){a.remoteMinFrameRate=k}if(k<=a.remoteMaxFrameRate*0.4&&k<=j*0.4){a.frameWarning=true;for(var g=0;g<a.probes.length;++g){var h=a.probes[g];h.onFrameRateWarning(a,k,j,a.remoteMaxFrameRate)}}else{if(a.frameWarning){for(var g=0;g<a.probes.length;++g){var h=a.probes[g];h.onFrameRateRecovering(a,k,j,a.remoteMaxFrameRate)}a.frameWarning=false;if(k>=6){a.remoteMaxFrameRate=-1}}}})}}},_stopCalculate:function(){if(this.timerList.length==0){return}for(var a=0;a<this.timerList.length;++a){var b=this.timerList[a];clearInterval(b)}this.timerList.splice(0,this.timerList.length)},_calculateStats:function(d,h){var b=new Date().getTime();var f=0,e=0,c=b,a=b;var g=0;g=window.setInterval(function(){if(d.webkitDecodedFrameCount===undefined){if(d.mozPaintedFrames===undefined){console.log("Video FPS calcs not supported");clearInterval(g);return}}var l=new Date().getTime();var i=(l-c)/1000;var k=(l-a)/1000;c=l;var m=0;var j=0;if(d.mozPaintedFrames!==undefined){m=(d.mozPaintedFrames-f)/i;j=d.mozPaintedFrames/k;f=d.mozPaintedFrames}else{m=(d.webkitDecodedFrameCount-f)/i;j=d.webkitDecodedFrameCount/k;f=d.webkitDecodedFrameCount}if(m<0||m>60){m=0}h.call(null,d,m.toFixed(),j.toFixed());if((parseInt(d.width)==0&&j==0)||d.src==null){clearInterval(g)}},1000);this.timerList.push(g)},openVideo:function(){if(null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0){this.worker.localStream.getVideoTracks()[0].enabled=true;this.worker.consult("video","open");return true}return false},closeVideo:function(){if(null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0){this.worker.localStream.getVideoTracks()[0].enabled=false;this.worker.consult("video","close");return true}return false},isVideoEnabled:function(){if(null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0){return this.worker.localStream.getVideoTracks()[0].enabled}return true},openVoice:function(){if(null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0){this.worker.localStream.getAudioTracks()[0].enabled=true;return true}return false},closeVoice:function(){if(null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0){this.worker.localStream.getAudioTracks()[0].enabled=false;return true}return false},isVoiceEnabled:function(){if(null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0){return this.worker.localStream.getAudioTracks()[0].enabled}return true},setVolume:function(a){if(null!=this.worker.remoteVideo){this.worker.remoteVideo.volume=a/100}},getVolume:function(){return parseInt(Math.round(this.worker.remoteVideo.volume*100))},mute:function(){this.closeVoice()},queryRecordArchives:function(b,g,a,f){if("undefined"!==f&&f){var e="p"+Date.now();window._cube_cross.addCallback(e,g,a);var d=window._cube_cross.host+"/archive/list.js?name="+b+"&m=window._cube_cross.queryRecordArchives&sn="+e;var c=document.createElement("script");c.setAttribute("id",e);c.setAttribute("name",b.toString());c.setAttribute("src",d);c.setAttribute("type","text/javascript");c.onerror=function(){if(undefined!==a){a.call(null,b)}document.body.removeChild(c)};document.body.appendChild(c);return}utils.requestGet("archive/list?name="+b,function(h){g.call(null,b,h)},function(h){if(undefined!==a){a.call(null,b)}})},loadArchive:function(b,c,a,e){var d=a;if(typeof a==="string"){d=document.getElementById(a)}if("undefined"!==e&&e){d.src=window._cube_cross.host+"/archive/read?name="+b+"&file="+c}else{d.src="archive/read?name="+b+"&file="+c}},hasLocalRecorded:function(){if(null==this.recorderMap){return false}return this.recorderMap.containsKey("LocalVideo")},isLocalRecording:function(){if(null==this.recorderMap){return false}var a=this.recorderMap.get("LocalVideo");if(a==null){return false}return a.recording},startLocalRecording:function(a){if(null==this.worker.localStream){return false}return this.startRecording("LocalVideo",this.worker.localStream,a)},stopLocalRecording:function(a){return this.stopRecording("LocalVideo",a)},replayLocalRecording:function(a,b){return this.replayRecording("LocalVideo",a,b)},getLocalRecorder:function(){return this.getRecorder("LocalVideo")},hasRemoteRecorded:function(){if(null==this.recorderMap){return false}return this.recorderMap.containsKey("RemoteVideo")},isRemoteRecording:function(){if(null==this.recorderMap){return false}var a=this.recorderMap.get("RemoteVideo");if(a==null){return false}return a.recording},startRemoteRecording:function(a){if(null==this.worker.remoteStream){return false}return this.startRecording("RemoteVideo",this.worker.remoteStream,a)},stopRemoteRecording:function(a){return this.stopRecording("RemoteVideo",a)},getRemoteRecorder:function(){return this.getRecorder("RemoteVideo")},startRecording:function(b,d,c){var e=null;var f=null;if(typeof d==="string"){e=document.getElementById(d)}else{if(d.tagName!==undefined){e=d}else{f=d}}if(null==this.recorderMap){this.recorderMap=new HashMap()}var a=null;if(c!=="undefined"&&null!=c){a=new CubeAdvancedRecorder(e,c)}else{a=new CubeRecorder(e)}this.recorderMap.put(b,a);return a.startRecording(f)},stopRecording:function(c,e){if(null==this.recorderMap){return false}var b=this.recorderMap.get(c);if(null==b){return false}var a=0;var d=b.stopRecording(function(f){if(null==e){return}if(a>0){clearTimeout(a)}a=setTimeout(function(){clearTimeout(a);e.call(null,b)},1000)});return d},replayRecording:function(b,c,f){if(null==this.recorderMap){return false}var a=this.recorderMap.get(b);if(null==a){return false}var e=null;if(typeof c==="string"){e=document.getElementById(c)}else{e=c}var d=null;if(typeof f==="string"){d=document.getElementById(f)}else{d=f}return a.replay(e,d)},getRecorder:function(a){if(null==this.recorderMap){return null}return this.recorderMap.get(a)}});(function(){if(window._cube_cross===undefined){window._cube_cross={host:"http://"+_CUBE_DOMAIN,callbackMap:{},addCallback:function(c,b,a){this.callbackMap[c]=b}}}window._cube_cross.queryRecordArchives=function(e,b){var d=document.getElementById(e);var a=d.getAttribute("name");var c=window._cube_cross.callbackMap[e];c.call(null,a,b);document.body.removeChild(d);d=null;delete window._cube_cross.callbackMap[e]}})();var CubeGroupListener=Class({ctor:function(){},onGroupCreated:function(a){},onGroupDestroyed:function(a){},onMemberAdded:function(c,a,b){},onMemberRemoved:function(c,a,b){}});var CubeGroupWorker=Class({engine:null,grpCb:null,dtlCb:null,ctor:function(a){this.engine=a},createGroup:function(e,a,b){if(null==a){a=e}var d={name:e.toString(),displayName:a.toString()};if("undefined"!==b&&null!=b){d.members=b}var c=new ActionDialect();c.setAction(CubeConst.ActionCreateGroup);c.appendParam("group",d);return nucleus.talkService.talk(_MSTR_CELLET,c)},deleteGroup:function(c){var b={name:c.toString()};var a=new ActionDialect();a.setAction(CubeConst.ActionDeleteGroup);a.appendParam("group",b);return nucleus.talkService.talk(_MSTR_CELLET,a)},addMembers:function(d,c){var b={name:d.toString(),members:c};var a=new ActionDialect();a.setAction(CubeConst.ActionAddMember);a.appendParam("group",b);return nucleus.talkService.talk(_MSTR_CELLET,a)},removeMembers:function(d,c){var b={name:d.toString(),members:c};var a=new ActionDialect();a.setAction(CubeConst.ActionRemoveMember);a.appendParam("group",b);return nucleus.talkService.talk(_MSTR_CELLET,a)},queryGroups:function(c){this.grpCb=c;var a=this.engine.session.name;var b=new ActionDialect();b.setAction(CubeConst.ActionQueryGroups);b.appendParam("group",{name:a});return nucleus.talkService.talk(_MSTR_CELLET,b)},queryGroupDetails:function(c,b){this.dtlCb=b;var a=new ActionDialect();a.setAction(CubeConst.ActionGetGroup);a.appendParam("group",c);return nucleus.talkService.talk(_MSTR_CELLET,a)},onDialogue:function(b,a){if(b==CubeConst.ActionQueryGroupsAck){}else{if(b==CubeConst.ActionGetGroupAck){}else{if(b==CubeConst.ActionCreateGroupAck){}else{if(b==CubeConst.ActionDeleteGroupAck){}else{if(b==CubeConst.ActionAddMemberAck){}else{if(b==CubeConst.ActionRemoveMemberAck){}else{if(b==CubeConst.ActionCreateGroup){}else{if(b==CubeConst.ActionDeleteGroup){}else{if(b==CubeConst.ActionAddMember){}else{if(b==CubeConst.ActionRemoveMember){}}}}}}}}}}}});var CubePeer=Class({name:null,displayName:null,ctor:function(a){this.name=a},getName:function(){return this.name},getDisplayName:function(){return this.displayName}});var CubeSession=Class({name:null,displayName:null,regState:CubeRegistrationState.None,callPeer:null,callDirection:null,callState:0,ctor:function(){this.regState=CubeRegistrationState.None},getName:function(){return this.name},getDisplayName:function(){return this.displayName},hasRegistered:function(){return(this.regState==CubeRegistrationState.Ok)},getRegState:function(){return this.regState},setCallPeer:function(a){this.callPeer=a},getCallPeer:function(){return this.callPeer},getCallDirection:function(){return this.callDirection},isCalling:function(){return(this.callState==CubeSignalingState.Invite||this.callState==CubeSignalingState.Incall)},getLatency:function(){var b=-1;if(nucleus.talkService.isCalled(_S_CELLET)){b=nucleus.talkService.getPingPongTime(_S_CELLET)}var a=-1;if(nucleus.talkService.isCalled(_M_CELLET)){a=nucleus.talkService.getPingPongTime(_M_CELLET)}var e=-1;if(nucleus.talkService.isCalled(_WB_CELLET)){e=nucleus.talkService.getPingPongTime(_WB_CELLET)}var f=0;var d=0;if(b>0){d+=b;++f}if(a>0){d+=a;++f}if(e>0){d+=e;++f}return(f>0)?parseInt(Math.round(d/f)):-1}});var _M_CELLET="CubeMessaging";var _S_CELLET="CubeSignaling";var _WB_CELLET="CubeWhiteboard";var _MSTR_CELLET="CubeMaster";var _VALID_CELLETS=[];var _CUBE_DOMAIN="211.103.217.154";var _CUBE_CONF_DOMAIN="211.103.217.154";var _CUBE_PORT=7070;var _CUBE_STUN="123.57.251.18:3478";var _CUBE_TURN_NAME="cube";var _CUBE_TURN_CRDL="cube887";var CubeEngine=Class({version:"1.3.50",config:null,delayTimer:0,hostAddress:null,session:null,registered:false,accName:null,accPassword:null,accDisplayName:null,sipWorker:null,sipMediaController:null,sspWorker:null,sspMediaController:null,msgWorker:null,wbMap:null,wbList:null,groupWorker:null,regListener:null,callListener:null,messageListener:null,wbListener:null,queryCallback:null,ctor:function(){this.session=new CubeSession()},_adjust:function(a){if(undefined!==a.host){_CUBE_DOMAIN=a.host.toString()}if(undefined!==a.confhost){_CUBE_CONF_DOMAIN=a.confhost.toString()}if(undefined!==a.port){_CUBE_PORT=parseInt(a.port)}if(undefined!==a.stun){_CUBE_STUN=a.stun.toString()}if(undefined!==a.turnName){_CUBE_TURN_NAME=a.turnName.toString()}if(undefined!==a.turnCrdl){_CUBE_TURN_CRDL=a.turnCrdl.toString()}if(undefined!==a.stun||undefined!==a.turnName||undefined!==a.turnCrdl){if(null!=this.sspWorker){this.sspWorker.iceServersUrls=null}}if(null!=this.sspWorker){if(a.single){this.sspWorker.iceServersUrls=[{urls:["stun:"+_CUBE_STUN]},{urls:["turn:"+_CUBE_STUN],username:_CUBE_TURN_NAME,credential:_CUBE_TURN_CRDL}]}else{this.sspWorker.iceServersUrls=[{urls:["stun:"+_CUBE_DOMAIN+":3478","stun:"+_CUBE_STUN]},{urls:["turn:"+_CUBE_DOMAIN+":3478","turn:"+_CUBE_STUN],username:_CUBE_TURN_NAME,credential:_CUBE_TURN_CRDL}]}}},startup:function(b){var a=this;console.log("Cube Engine for HTML5/JavaScript v"+a.version);a.hostAddress=new InetAddress(_CUBE_DOMAIN,_CUBE_PORT);var d=function(){if(window.nucleus.startup()){nucleus.talkService.addListener(new CubeNetworkListener(a));if(undefined!==b){b.call(null,a)}return true}else{return false}};if(window.utils.isIE9){window.WEB_SOCKET_FORCE_FLASH=true;nucleus.activateWSPlugin(_CUBE_DOMAIN.indexOf("192")>=0?"libs/ws":"http://"+_CUBE_DOMAIN+"/libs/ws",function(){d()});return true}else{var c=setTimeout(function(){clearTimeout(c);d()},50);return true}},shutdown:function(){if(this.delayTimer>0){clearTimeout(this.delayTimer);this.delayTimer=0}window.nucleus.shutdown()},configure:function(b){this.config=b;if(b.videoSize!==undefined){if(null!=this.sspWorker){this.sspWorker.maxVideoSize=b.videoSize}if(null!=this.sipWorker){this.sipWorker.maxVideoSize=b.videoSize}Logger.d("CubeEngine","Config video size: "+b.videoSize.width+"x"+b.videoSize.height)}if(b.frameRate!==undefined){var a=parseInt(b.frameRate.min);if(a>10){a=10}else{if(a<2){a=2}}var c=parseInt(b.frameRate.max);if(c>30){c=30}else{if(c<6){c=6}}if(null!=this.sspWorker){this.sspWorker.minFrameRate=a;this.sspWorker.maxFrameRate=c}if(null!=this.sipWorker){this.sipWorker.minFrameRate=a;this.sipWorker.maxFrameRate=c}Logger.d("CubeEngine","Config frame rate: ["+a+","+c+"]")}if(b.bandwidth){if(null!=this.sspWorker){this.sspWorker.setBandwidth(b.bandwidth.audio||60,b.bandwidth.video||256)}}},getSession:function(){return this.session},registerAccount:function(d,c,a){if(_VALID_CELLETS.length==0){return false}this.accName=d+"";this.accPassword=c+"";if(a===undefined||a.length==0){this.accDisplayName=this.accName}else{this.accDisplayName=a.toString()}this.session.name=this.accName;this.session.displayName=this.accDisplayName;var b=this;if(null!=b.sipWorker){b.sipWorker.registerWith(d,c,this.accDisplayName)}var h=[];for(var g=0;g<_VALID_CELLETS.length;++g){if(_VALID_CELLETS[g]==_MSTR_CELLET){continue}if(nucleus.talkService.isCalled(_VALID_CELLETS[g])){h.push(_VALID_CELLETS[g])}}if(h.length==0){nucleus.talkService.recall()}b._fireRegistrationState(CubeRegistrationState.Progress);var f=(null!=b.config&&"undefined"!==b.config.deviceName)?b.config.deviceName:navigator.appName;for(var g=0;g<h.length;++g){var e=new ActionDialect();e.setAction(CubeConst.ActionLogin);e.appendParam("data",{name:b.accName,displayName:b.accDisplayName,password:c,version:b.version,device:{name:f,version:navigator.appVersion,platform:navigator.platform,userAgent:navigator.userAgent}});nucleus.talkService.talk(h[g],e)}h=null;return true},unregisterAccount:function(){if(this.session.isCalling()){this.terminateCall()}this._fireRegistrationState(CubeRegistrationState.Cleared);if(null!=this.sipWorker){this.sipWorker.unregister()}var e=[];if(nucleus.talkService.isCalled(_M_CELLET)){e.push(_M_CELLET)}if(nucleus.talkService.isCalled(_S_CELLET)){e.push(_S_CELLET)}if(nucleus.talkService.isCalled(_WB_CELLET)){e.push(_WB_CELLET)}if(e.length>0){var a=this;var d=(null!=a.config&&"undefined"!==a.config.deviceName)?a.config.deviceName:navigator.appName;for(var c=0;c<e.length;++c){var b=new ActionDialect();b.setAction(CubeConst.ActionLogout);b.appendParam("data",{name:a.accName,password:a.accPassword,version:a.version,device:{name:d,version:navigator.appVersion,platform:navigator.platform,userAgent:navigator.userAgent}});nucleus.talkService.talk(e[c],b)}}e=null;this.accName=null;this.accDisplayName=null;this.accPassword=null;this.session.name=null;return true},queryRemoteAccounts:function(a,b){this.queryAccounts(a,b)},queryAccounts:function(b,c){if(null==this.msgWorker){return false}if(!nucleus.talkService.isCalled(_M_CELLET)&&!nucleus.talkService.isCalled(_S_CELLET)){return false}if(undefined!==c){this.queryCallback=c}else{return false}var a=new ActionDialect();a.setAction(CubeConst.ActionQuery);a.appendParam("data",{list:b});if(nucleus.talkService.isCalled(_M_CELLET)){nucleus.talkService.talk(_M_CELLET,a);return true}else{if(nucleus.talkService.isCalled(_S_CELLET)){nucleus.talkService.talk(_S_CELLET,a);return true}else{if(nucleus.talkService.isCalled(_WB_CELLET)){nucleus.talkService.talk(_WB_CELLET,a);return true}else{return false}}}},queryMessageHistory:function(b,a,c){if(null==this.msgWorker){return false}return this.msgWorker.queryHistory(b,a,c)},loadConference:function(a,d,e,c){if("undefined"!==CubeSIPWorker&&null==this.sipWorker){this.sipWorker=new CubeSIPWorker(_CUBE_CONF_DOMAIN);this.sipWorker.start(this,document.getElementById(a),document.getElementById(d),(e!==undefined)?document.getElementById(e):null);this.sipMediaController=new CubeMediaController(this.sipWorker,c)}if(null==this.groupWorker){this.groupWorker=new CubeGroupWorker(this);_VALID_CELLETS.push(_MSTR_CELLET);if(this.delayTimer>0){clearTimeout(this.delayTimer)}var b=this;this.delayTimer=setTimeout(function(){clearTimeout(b.delayTimer);b.delayTimer=0;nucleus.talkService.call(_VALID_CELLETS,b.hostAddress,true)},500)}return true},loadSignaling:function(a,c,d){if(null!=this.sspWorker){return true}this.sspWorker=new CubeSignalingWorker(document.getElementById(a),document.getElementById(c),(d!==undefined)?document.getElementById(d):null);this.sspWorker.setDelegate(new CubeSignalingWorkerDelegate(this));if(null!=this.config){this.sspWorker.maxVideoSize=this.config.videoSize}_VALID_CELLETS.push(_S_CELLET);if(this.delayTimer>0){clearTimeout(this.delayTimer)}var b=this;this.delayTimer=setTimeout(function(){clearTimeout(b.delayTimer);b.delayTimer=0;nucleus.talkService.call(_VALID_CELLETS,b.hostAddress,true)},500);this.sspMediaController=new CubeMediaController(this.sspWorker);if(!nucleus.ts.isWebSocketSupported()){window.console.log("Adapter WebSocket");nucleus.ts.resetHeartbeat(_S_CELLET,2000)}return true},loadMessager:function(){if(null!=this.msgWorker){return true}this.msgWorker=new CubeMessageWorker();this.msgWorker.setDelegate(new CubeMessageWorkerDelegate(this));_VALID_CELLETS.push(_M_CELLET);if(this.delayTimer>0){clearTimeout(this.delayTimer)}var a=this;this.delayTimer=setTimeout(function(){clearTimeout(a.delayTimer);a.delayTimer=0;nucleus.talkService.call(_VALID_CELLETS,a.hostAddress,true)},500);return true},loadWhiteboard:function(c){if(null==this.wbMap){this.wbMap=new HashMap()}if(null==this.wbList){this.wbList=new Array()}_VALID_CELLETS.push(_WB_CELLET);if(this.delayTimer>0){clearTimeout(this.delayTimer)}var a=this;this.delayTimer=setTimeout(function(){clearTimeout(a.delayTimer);a.delayTimer=0;nucleus.talkService.call(_VALID_CELLETS,a.hostAddress,true)},500);var b=new CubeWhiteboard(c,new CubeWhiteboardDelegate(this));b.load();this.wbMap.put(b.getName(),b);this.wbList.push(b);return b},setRegistrationListener:function(a){this.regListener=a},setCallListener:function(a){this.callListener=a},setMessageListener:function(a){this.messageListener=a},setWhiteboardListener:function(a){this.wbListener=a},makeCall:function(b,a){b=b.toString();if(b.length<=4&&null!=this.sipWorker){this.session.setCallPeer(new CubePeer(b));return this.sipWorker.invite(b,a)}if(null!=this.sspWorker){this.session.setCallPeer(new CubePeer(b));return this.sspWorker.invite(b,a)}else{if(null!=this.sipWorker){this.session.setCallPeer(new CubePeer(b));return this.sipWorker.invite(b,a)}else{return false}}},answerCall:function(){if(this.session.callPeer.name.length<=4&&null!=this.sipWorker){return this.sipWorker.answer()}if(null!=this.sspWorker){return this.sspWorker.answer()}else{if(null!=this.sipWorker){return this.sipWorker.answer()}else{return false}}},terminateCall:function(){if(null!=this.session.callPeer&&this.session.callPeer.name.length<=4&&null!=this.sipWorker){return this.sipWorker.hangup()}var b=false;var a=false;if(null!=this.sspWorker){b=this.sspWorker.hangup()}if(null!=this.sipWorker){a=this.sipWorker.hangup()}return(b||a)},autoAnswer:function(a){if(null!=this.sspWorker){this.sspWorker.setAutoAnswer(a)}},getMediaController:function(){if(null!=this.session.callPeer){if(this.session.callPeer.name.length<=4&&null!=this.sipWorker){return this.sipMediaController}else{return this.sspMediaController}}else{return this.sspMediaController}},mc:function(){return this.getMediaController()},getConferenceUA:function(){if(null==this.sspWorker){return null}return this.sspWorker.cua()},cua:function(){if(null==this.sspWorker){return null}return this.sspWorker.cua()},sendMessage:function(a,b){if(null==this.msgWorker){return false}if(!nucleus.talkService.isCalled(_M_CELLET)){return false}return this.msgWorker.pushMessage(a,b)},getWhiteboard:function(c){if(null==this.wbList){return null}if(c===undefined){return this.wbList[0]}for(var a=0;a<this.wbList.length;++a){var b=this.wbList[a];if(b.domId==c){return b}}return null},queryGroups:function(a){if(!nucleus.talkService.isCalled(_MSTR_CELLET)){return false}if(null==this.groupWorker){return false}return this.groupWorker.queryGroups(a)},queryGroupDetails:function(b,a){if(!nucleus.talkService.isCalled(_MSTR_CELLET)){return false}if(null==this.groupWorker){return false}return this.groupWorker.queryGroupDetails(b,a)},createGroup:function(c,a,b){},deleteGroup:function(a){},addMembers:function(b,a){},removeMembers:function(b,a){},warmUp:function(j,q){if(null==this.sspWorker){if(undefined!==q){q.call(null)}return}var f=navigator.getUserMedia||window.getUserMedia;if(undefined===f||null==f){if(undefined!==q){q.call(null)}return}var e=document.body.style.overflow;var p=window.innerWidth;var i=window.innerHeight;document.body.style.overflow="hidden";var o=parseInt((p-480)*0.5);var n=parseInt((i-480)*0.5)-40;var m=parseInt((p-200-200-40)*0.5);var k=parseInt(n+480+10);var r=['<div style="position:absolute;float:left;left:0px;top:0px;opacity:0.7;-moz-opacity:0.7;-webkit-opacity:0.7;background:#000;',"width:",p,"px;height:",i,'px"></div>','<video id="_cube_warmup_video" width="480" height="480" style="position:absolute;float:left;left:',o,"px;top:",n,'px;background:#101010;" autoplay></video>','<button id="_cube_warmup_yes" style="width:200px;height:30px;position:absolute;float:left;left:',m,"px;top:",k,'px;">我看到了视频</button>','<button id="_cube_warmup_no" style="width:200px;height:30px;position:absolute;float:left;left:',m+240,"px;top:",k,'px;">我没有看到视频</button>'];var l=document.createElement("div");l.style.position="absolute";l.style.styleFloat="left";l.style.cssFloat="left";l.style.left="0px";l.style.top="0px";l.style.width=p+"px";l.style.height=i+"px";l.style.zIndex=9998;l.innerHTML=r.join("");document.body.appendChild(l);var a=document.getElementById("_cube_warmup_video");var g=null;if(utils.isIE||utils.isSafari){navigator.getUserMedia=window.getUserMedia}navigator.getUserMedia({audio:true,video:true},function(c){g=c;if(utils.isIE||utils.isSafari){window.attachMediaStream(a,c);a=document.getElementById("_cube_warmup_video");a.style.position="absolute";a.style.styleFloat="left";a.style.cssFloat="left";a.style.left=o+"px";a.style.top=n+"px";a.style.zIndex=9999;return}if(window.URL){a.src=window.URL.createObjectURL(g)}else{a.src=g}a.onloadedmetadata=function(h){a.play()}},function(c){document.body.removeChild(l);document.body.style.overflow=e;if(undefined!==q){q.call(null)}});var d=function(){if(utils.isIE||utils.isSafari){window.attachMediaStream(document.getElementById("_cube_warmup_video"),null)}else{a.src=""}if(null!=g){g.stop();g=null}document.body.removeChild(l);document.body.style.overflow=e};var b=document.getElementById("_cube_warmup_yes");b.addEventListener("click",function(c){d();if(undefined!==j){j.call(null)}},false);b=document.getElementById("_cube_warmup_no");b.addEventListener("click",function(c){d();if(undefined!==q){q.call(null)}},false)},_fireRegistrationState:function(d){if(d!=this.session.regState){this.session.regState=d;if(null!=this.regListener){if(d==CubeRegistrationState.Progress){this.regListener.onRegistrationProgress(this.session)}else{if(d==CubeRegistrationState.Ok){this.regListener.onRegistrationOk(this.session)}else{if(d==CubeRegistrationState.Cleared){this.regListener.onRegistrationCleared(this.session);if(this.session.isCalling()){this.terminateCall()}}else{if(d==CubeRegistrationState.Failed){this.regListener.onRegistrationFailed(this.session,CubeErrorCode.BadRequest)}}}}}}if(null!=this.sspWorker){this.sspWorker.onRegisterStateChanged(this.session)}if(null!=this.msgWorker){this.msgWorker.onRegisterStateChanged(this.session)}if(null!=this.wbList&&this.wbList.length>0){var c=this.wbList;for(var a=0;a<c.length;++a){var b=c[a];b.onRegisterStateChanged(this.session)}}},_processLoginAck:function(a){var b=a.getParam("state");if(b.code==200){this.registered=true;this._fireRegistrationState(CubeRegistrationState.Ok)}else{Logger.w("CubeEngine","login failed");this._fireRegistrationState(CubeRegistrationState.Failed)}},_processQueryAck:function(a){if(null!=this.queryCallback){var b=a.getParam("data");this.queryCallback.call(null,b.list);this.queryCallback=null}}});var CubeNetworkListener=Class(TalkListener,{engine:null,ctor:function(a){TalkListener.prototype.ctor.call(this);this.engine=a},dialogue:function(b,a){if(a.isDialectal()){var d=a.getDialect();if(ActionDialect.DIALECT_NAME==d.getName()){var f=d.getAction();if(f==CubeConst.ActionLoginAck){this.engine._processLoginAck(d);return}else{if(f==CubeConst.ActionQueryAck){this.engine._processQueryAck(d);return}}if(b==_WB_CELLET){if(null!=this.engine.wbList&&this.engine.wbList.length>0){var e=this.engine.wbList;for(var c=0;c<e.length;++c){e[c].onDialogue(f,d)}}}else{if(b==_M_CELLET){if(null!=this.engine.msgWorker){this.engine.msgWorker.onDialogue(f,d)}}else{if(b==_S_CELLET){if(null!=this.engine.sspWorker){this.engine.sspWorker.onDialogue(f,d)}}else{if(b==_MSTR_CELLET){if(null!=this.engine.groupWorker){this.engine.groupWorker.onDialogue(f,d)}}}}}}}},contacted:function(e,k){console.log("*** contacted: "+e);if(!this.engine.registered&&null!=this.engine.accName&&null!=this.engine.accPassword){this.engine._fireRegistrationState(CubeRegistrationState.Progress);var a=this.engine.accName;var h=this.engine.accDisplayName;var j=this.engine.accPassword;var f=this.engine.version;var d=(null!=this.engine.config&&"undefined"!==this.engine.config.deviceName)?this.engine.config.deviceName:navigator.appName;var g=[];if(null!=this.engine.msgWorker){g.push(_M_CELLET)}if(null!=this.engine.sspWorker){g.push(_S_CELLET)}if(null!=this.engine.wbMap){g.push(_WB_CELLET)}for(var c=0;c<g.length;++c){var b=new ActionDialect();b.setAction(CubeConst.ActionLogin);b.appendParam("data",{name:a,displayName:h,password:j,version:f,device:{name:d,version:navigator.appVersion,platform:navigator.platform,userAgent:navigator.userAgent}});nucleus.talkService.talk(g[c],b)}g=null}},quitted:function(b,a){console.log("*** quitted: "+b);if(null!=this.engine.sspWorker){if(this.engine.session.isCalling()){this.engine.terminateCall()}}if(this.engine.registered){this.engine._fireRegistrationState(CubeRegistrationState.Cleared);if(null!=this.engine.sipWorker){this.engine.sipWorker.unregister()}this.engine.registered=false}},failed:function(a,b){console.log("*** failed: "+a+" - "+b.getDescription());if(null!=this.engine.regListener){this.engine.regListener.onRegistrationFailed(this.engine.session,CubeErrorCode.NetworkNotReachable)}var c=setTimeout(function(){clearTimeout(c);nucleus.talkService.recall()},10000)}});(function(a){CubeEngine.sharedInstance=new CubeEngine();a.cube=CubeEngine.sharedInstance})(window);